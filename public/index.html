<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Quiz Lobby</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; display:flex; align-items:center; justify-content:center; height:100vh; margin:0;}
    .card { background: rgba(0,0,0,0.45); padding:24px; border-radius:12px; width:460px; text-align:center;}
    input { width:86%; padding:10px; margin:8px 0; border-radius:8px; border:none; font-size:14px; }
    button { padding:10px 16px; margin:6px; border-radius:8px; border:none; cursor:pointer; background:#ffca28; color:#222; }
    #lobbyUI { display:none; margin-top:12px; text-align:left; }
    .playerBox { background:#071427; padding:8px; margin:6px 0; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
    .ownerBadge { color:#ffd700; font-weight:bold; margin-left:8px; font-size:12px; }
    .small { font-size:12px; color:#ffefc6; }
    #error { color:#ffaaaa; display:none; margin-top:8px; }
    .code { font-weight:700; letter-spacing:2px; font-size:18px; margin-left:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Quiz Lobby</h2>

    <div id="joinUI">
      <input id="playerName" placeholder="Your name" /><br>
      <button id="createBtn">Create Room</button><br>
      <input id="roomCodeInput" placeholder="Enter room code to join" /><br>
      <button id="joinBtn">Join Room</button>
      <p id="error"></p>
      <p class="small">Tip: room codes are case-insensitive. Owner controls appear only for the true owner.</p>
    </div>

    <div id="lobbyUI">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><strong>Room Code:</strong> <span class="code" id="roomCodeDisplay"></span></div>
        <div id="ownerInfo" class="small"></div>
      </div>

      <div id="playersList" style="margin-top:12px;"></div>

      <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
        <div id="startContainer"></div>
        <div id="leaveContainer"></div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const createBtn = document.getElementById("createBtn");
    const joinBtn = document.getElementById("joinBtn");
    const playerNameInput = document.getElementById("playerName");
    const roomCodeInput = document.getElementById("roomCodeInput");
    const errorBox = document.getElementById("error");
    const lobbyUI = document.getElementById("lobbyUI");
    const joinUI = document.getElementById("joinUI");
    const roomCodeDisplay = document.getElementById("roomCodeDisplay");
    const playersList = document.getElementById("playersList");
    const startContainer = document.getElementById("startContainer");
    const leaveContainer = document.getElementById("leaveContainer");
    const ownerInfo = document.getElementById("ownerInfo");

    let currentRoom = null;
    let mySocketId = null;
    let serverOwnerId = null;

    function showError(msg) {
      errorBox.innerText = msg;
      errorBox.style.display = "block";
      setTimeout(()=> errorBox.style.display = "none", 4500);
    }

    function setLobbyVisible(code) {
      joinUI.style.display = "none";
      lobbyUI.style.display = "block";
      roomCodeDisplay.innerText = code;
      createLeaveButton();
    }

    function ensureSocketConnected() {
      if (socket.connected) return Promise.resolve();
      return new Promise(resolve => socket.once('connect', resolve));
    }

    // REST-first create, fallback to socket create
    async function createRoomFlow(name) {
      try {
        const res = await fetch('/api/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
        if (!res.ok) throw new Error('REST create failed');
        const j = await res.json();
        return { ok:true, code: j.code };
      } catch(e) {
        // fallback socket create
        return new Promise(resolve => {
          socket.emit('createRoomSocket', { name }, (resp) => {
            if (resp?.success) resolve({ ok:true, code: resp.code });
            else resolve({ ok:false, message: resp?.message || 'Socket create failed' });
          });
        });
      }
    }

    async function joinRoomFlow(code, name) {
      code = String(code || '').trim().toUpperCase();
      try {
        const res = await fetch('/api/join', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, name }) });
        if (!res.ok) {
          const j = await res.json().catch(()=>({ error: 'Join failed' }));
          return { ok:false, message: j.error || j.message || 'Join failed' };
        }
        return { ok:true, code };
      } catch(e) {
        // fallback: allow socket to try join (server will validate)
        return { ok:true, code };
      }
    }

    function socketJoin(code, name, isOwnerClaim=false) {
      return new Promise(resolve => {
        ensureSocketConnected().then(() => {
          socket.emit('joinRoom', { code, name, isOwner: !!isOwnerClaim }, (resp) => {
            resolve(resp || { success:false, message:'No response' });
          });
        });
      });
    }

    createBtn.onclick = async () => {
      const name = playerNameInput.value.trim();
      if (!name) return showError('Enter your name');
      const createResp = await createRoomFlow(name);
      if (!createResp.ok) return showError(createResp.message || 'Could not create room');
      const code = createResp.code;
      const joinResp = await socketJoin(code, name, true);
      if (!joinResp.success) return showError(joinResp.message || 'Socket join failed after create');
      currentRoom = code;
      localStorage.setItem('roomCode', currentRoom);
      localStorage.setItem('playerName', name);
      localStorage.setItem('isOwner', 'true');
      setLobbyVisible(currentRoom);
    };

    joinBtn.onclick = async () => {
      const name = playerNameInput.value.trim();
      const codeRaw = roomCodeInput.value.trim();
      if (!name || !codeRaw) return showError('Enter both name and room code');
      const code = codeRaw.toUpperCase().trim();

      const pre = await joinRoomFlow(code, name);
      if (!pre.ok) return showError(pre.message || 'Cannot join room');

      const joinResp = await socketJoin(code, name, false);
      if (!joinResp.success) return showError(joinResp.message || 'Socket join failed');

      currentRoom = code;
      localStorage.setItem('roomCode', currentRoom);
      localStorage.setItem('playerName', name);
      localStorage.setItem('isOwner', 'false');
      setLobbyVisible(currentRoom);
    };

    function renderPlayers(players, ownerId) {
      serverOwnerId = ownerId;
      playersList.innerHTML = '';
      players.forEach(p => {
        const div = document.createElement('div');
        div.className = 'playerBox';
        const left = document.createElement('div'); left.innerText = p.name;
        const right = document.createElement('div'); right.innerHTML = `${p.score ?? 0} ${p.id === ownerId ? "<span class='ownerBadge'>(Owner)</span>": ""}`;
        div.appendChild(left); div.appendChild(right);

        // if I'm server owner, show Kick button for others
        if (serverOwnerId === mySocketId && p.id !== mySocketId) {
          const kickBtn = document.createElement('button');
          kickBtn.innerText = 'Kick';
          kickBtn.onclick = () => socket.emit('kickPlayer', { code: currentRoom, targetId: p.id });
          div.appendChild(kickBtn);
        }
        playersList.appendChild(div);
      });
      ownerInfo.innerText = serverOwnerId === mySocketId ? 'You are owner' : '';
      renderStartButton();
    }

    function renderStartButton() {
      startContainer.innerHTML = '';
      if (!currentRoom) return;
      if (serverOwnerId === mySocketId) {
        const startBtn = document.createElement('button');
        startBtn.innerText = 'Start Game';
        startBtn.onclick = () => socket.emit('startGame', currentRoom);
        startContainer.appendChild(startBtn);
      }
    }

    function createLeaveButton() {
      leaveContainer.innerHTML = '';
      if (!currentRoom) return;
      const leaveBtn = document.createElement('button');
      leaveBtn.innerText = 'Leave';
      leaveBtn.onclick = () => {
        localStorage.removeItem('roomCode');
        localStorage.removeItem('playerName');
        localStorage.removeItem('isOwner');
        location.reload();
      };
      leaveContainer.appendChild(leaveBtn);
    }

    socket.on('connect', () => {
      mySocketId = socket.id;
      tryAutoRejoin();
    });

    socket.on('playerList', ({ players, owner }) => {
      renderPlayers(players || [], owner);
    });

    socket.on('goToGamePage', () => window.location.href = '/game.html');

    socket.on('kicked', () => {
      alert('You were kicked by the owner.');
      localStorage.removeItem('roomCode');
      localStorage.removeItem('playerName');
      localStorage.removeItem('isOwner');
      location.reload();
    });

    socket.on('roomClosed', () => {
      alert('Room closed (owner left)');
      localStorage.removeItem('roomCode');
      localStorage.removeItem('playerName');
      localStorage.removeItem('isOwner');
      location.reload();
    });

    socket.on('errorMsg', (m) => showError(m || 'Server error'));

    async function tryAutoRejoin() {
      const savedCode = localStorage.getItem('roomCode');
      const savedName = localStorage.getItem('playerName');
      const savedIsOwner = localStorage.getItem('isOwner') === 'true';
      if (!savedCode || !savedName) return;
      // attempt REST validation (non-blocking)
      try { await fetch('/api/join', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code: savedCode, name: savedName }) }); } catch(e){}
      // socket join (reclaim owner if saved)
      const resp = await new Promise(resolve => socket.emit('joinRoom', { code: savedCode, name: savedName, isOwner: savedIsOwner }, (r) => resolve(r || { success:false })));
      if (resp?.success) {
        currentRoom = savedCode;
        setLobbyVisible(currentRoom);
      } else {
        // clear invalid saved state
        localStorage.removeItem('roomCode');
        localStorage.removeItem('playerName');
        localStorage.removeItem('isOwner');
      }
    }
  </script>
</body>
</html>
